package org.example.telegram;

import okhttp3.*;
import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;
import java.io.IOException;
import java.util.concurrent.TimeUnit;

public class GeminiService {
    private static final String API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent";
    private final String apiKey;
    private final OkHttpClient client;
    private final LanguageService languageService = new LanguageService();


    public GeminiService(String apiKey) {
        this.apiKey = apiKey;
        this.client = new OkHttpClient.Builder()
                .connectTimeout(30, TimeUnit.SECONDS)
                .readTimeout(30, TimeUnit.SECONDS)
                .writeTimeout(30, TimeUnit.SECONDS)
                .build();
    }

    private String handleApiError(Exception e) {
        System.err.println("–û—à–∏–±–∫–∞ –≤ API-–∑–∞–ø—Ä–æ—Å–µ: " + e.getMessage());
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –ò–ò. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    }

    public String getLegalAnswer(long chatid,String userQuery, boolean isClarifying, boolean isEnoughInfo, String category) {
        try {
            String prompt = buildPromptForCategory(chatid, userQuery, isEnoughInfo, category, isClarifying);
            JSONObject requestJson = new JSONObject()
                    .put("contents", new JSONArray()
                            .put(new JSONObject()
                                    .put("parts", new JSONArray()
                                            .put(new JSONObject().put("text", prompt)))));

            RequestBody body = RequestBody.create(requestJson.toString(), MediaType.get("application/json"));
            Request request = new Request.Builder()
                    .url(API_URL + "?key=" + apiKey)
                    .post(body)
                    .addHeader("Content-Type", "application/json")
                    .build();

            try (Response response = client.newCall(request).execute()) {
                if (!response.isSuccessful() || response.body() == null) {
                    return "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò: " + (response.body() != null ? response.body().string() : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
                }

                JSONObject responseJson = new JSONObject(response.body().string());
                JSONArray candidates = responseJson.optJSONArray("candidates");

                if (candidates != null && candidates.length() > 0) {
                    JSONObject content = candidates.getJSONObject(0).optJSONObject("content");
                    if (content != null) {
                        JSONArray parts = content.optJSONArray("parts");
                        if (parts != null && parts.length() > 0) {
                            String aiResponse = parts.getJSONObject(0).optString("text", "–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞");
                            return aiResponse + getAdText();
                        }
                    }
                }
            } catch (IOException | JSONException e) {
                return handleApiError(e);
            }
        } catch (Exception e) {
            return handleApiError(e);
        }

        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.";
    }

    private String getAdText() {
        return "\n\nüîπ –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ LexTrust! " +
                "üìû –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è üëâ [–ó–∞–ø–∏—Å–∞—Ç—å—Å—è](https://t.me/your_lawyer_bot)";
    }

    private String buildPromptForCategory(Long chatId, String userQuery, boolean isEnoughInfo, String category, boolean isClarifying) {
        String categoryTitle;
        String legalContext;
        String userLanguage = languageService.getUserLanguage(chatId);
        String languageNote = switch (userLanguage) {
            case "ru" -> "–û—Ç–≤–µ—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.";
            case "en" -> "Respond in English.";
            case "kz" -> "–ñ–∞—É–∞–ø “õ–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ –±–æ–ª—Å—ã–Ω.";
            default -> "–û—Ç–≤–µ—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.";
        };

        switch (category.toLowerCase()) {
            case "–∞–≤—Ç–æ–∞–≤–∞—Ä–∏—è":
                categoryTitle = "üöó –ê–≤—Ç–æ–∞–≤–∞—Ä–∏—è";
                legalContext = "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç –ø–æ –î–¢–ü –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ. –û—Ç–≤–µ—á–∞–π –ø–æ–ª–Ω–æ, —á–µ—Ç–∫–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ. " +
                        "–ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã –†–ö: –ü–î–î, –ö–æ–ê–ü –†–ö, –ì–ö –†–ö, –£–ö –†–ö –∏ —Å—Ç—Ä–∞—Ö–æ–≤–æ–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ. " +
                        "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤ –∏ —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É. " +
                        "–î–µ–ª–∞–π –æ—Ç–≤–µ—Ç—ã –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ª—é–¥–µ–π, –Ω–æ —Å —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é. ";
                break;
            case "—Ç—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ":
                categoryTitle = "üíº –¢—Ä—É–¥–æ–≤–æ–µ –ø—Ä–∞–≤–æ";
                legalContext = "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—Ä—É–¥–æ–≤–æ–º—É –ø—Ä–∞–≤—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. –û—Ç–≤–µ—á–∞–π —á–µ—Ç–∫–æ, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ. " +
                        "–ò—Å–ø–æ–ª—å–∑—É–π –¢—Ä—É–¥–æ–≤–æ–π –∫–æ–¥–µ–∫—Å –†–ö, –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –∫–æ–¥–µ–∫—Å –†–ö, –ö–æ–ê–ü –†–ö –∏ –ö–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏—é –†–ö. " +
                        "–û–±—ä—è—Å–Ω—è–π –ø—Ä–∞–≤–∞ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –∏ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è, –ø–æ—Ä—è–¥–æ–∫ —É–≤–æ–ª—å–Ω–µ–Ω–∏—è, –≤—ã–ø–ª–∞—Ç—ã, –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ –∏ —Å–ø–æ—Ä—ã –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ. " +
                        "–ü—Ä–∏–≤–æ–¥–∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤ –∏ —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É. ";
                break;
            case "–Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å":
                categoryTitle = "üè° –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å";
                legalContext = "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ. –î–∞–≤–∞–π —Ç–æ—á–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã, —Å—Å—ã–ª–∞—è—Å—å –Ω–∞ –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –∫–æ–¥–µ–∫—Å –†–ö, " +
                        "–ó–∞–∫–æ–Ω –†–ö '–û –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∞–≤ –Ω–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ', –ó–∞–∫–æ–Ω –†–ö '–û –∂–∏–ª–∏—â–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö' –∏ –ó–µ–º–µ–ª—å–Ω—ã–π –∫–æ–¥–µ–∫—Å –†–ö. " +
                        "–†–∞–∑—ä—è—Å–Ω—è–π –ø–æ—Ä—è–¥–æ–∫ –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏, –∞—Ä–µ–Ω–¥—ã, –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∏ –ø—Ä–∞–≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏. ";
                break;
            case "—Å–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ":
                categoryTitle = "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –°–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ";
                legalContext = "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç –ø–æ —Å–µ–º–µ–π–Ω–æ–º—É –ø—Ä–∞–≤—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. –î–∞–≤–∞–π —Ç–æ—á–Ω—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã, —Å—Å—ã–ª–∞—è—Å—å –Ω–∞ –°–µ–º–µ–π–Ω—ã–π –∫–æ–¥–µ–∫—Å –†–ö, " +
                        "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å—É–∞–ª—å–Ω—ã–π –∫–æ–¥–µ–∫—Å –†–ö (–µ—Å–ª–∏ —Ä–µ—á—å –æ —Å—É–¥–µ), –ö–æ–ê–ü –†–ö (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã –∑–∞ –Ω–µ–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π) –∏ –ì–ö –†–ö " +
                        "(–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è). " +
                        "–†–∞–∑—ä—è—Å–Ω—è–π –±—Ä–∞–∫–æ—Ä–∞–∑–≤–æ–¥–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, —Ä–∞–∑–¥–µ–ª –∏–º—É—â–µ—Å—Ç–≤–∞, –∞–ª–∏–º–µ–Ω—Ç—ã, –æ–ø–µ–∫—É –∏ —É—Å—ã–Ω–æ–≤–ª–µ–Ω–∏–µ. ";
                break;
            default:
                categoryTitle = "‚ùì –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã";
                legalContext = "–¢—ã –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —é—Ä–∏—Å—Ç, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. –û—Ç–≤–µ—á–∞–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ —Ç–æ—á–Ω–æ, " +
                        "–∏—Å–ø–æ–ª—å–∑—É—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã –∏ —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É. " +
                        "–ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω —Å –î–¢–ü ‚Äì –ø—Ä–∏–º–µ–Ω—è–π –ö–æ–ê–ü –†–ö, –ü–î–î –∏ —Å—Ç—Ä–∞—Ö–æ–≤—ã–µ –Ω–æ—Ä–º—ã. " +
                        "–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å ‚Äì –∏—Å–ø–æ–ª—å–∑—É–π –ì–ö –†–ö, –∑–∞–∫–æ–Ω—ã –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å—É–¥–µ–±–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É. " +
                        "–ü—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –ø–æ —Å–µ–º–µ–π–Ω–æ–º—É –ø—Ä–∞–≤—É ‚Äì —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ –°–ö –†–ö, –ì–ü–ö –†–ö –∏ –ì–ö –†–ö. ";
                break;
        }

        return languageNote  + "\n\n" +
                legalContext + "\n\n" +
                "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n\n" +
                categoryTitle + "\n\n" +
                "1. –ß—Ç–æ –¥–µ–ª–∞—Ç—å?\n" +
                "‚úÖ –û–ø–∏—à–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —à–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å, —Å —É—á–µ—Ç–æ–º –∑–∞–∫–æ–Ω–æ–≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞.\n\n" +
                "2. –ß—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ?\n" +
                "üö´ –£–∫–∞–∂–∏ –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ —à—Ç—Ä–∞—Ñ–∞–º –∏–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—é –∑–∞–∫–æ–Ω–∞, —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—Ç–∞—Ç—å—è–º–∏.\n\n" +
                "3. –ö–∞–∫ –≤—ã–∏–≥—Ä–∞—Ç—å –¥–µ–ª–æ?\n" +
                "üí° –î–∞–π —Å–æ–≤–µ—Ç—ã –ø–æ –∑–∞—â–∏—Ç–µ —Å–≤–æ–∏—Ö –ø—Ä–∞–≤, –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–≤.\n\n" +
                "4. –•–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ–±—ã—Ç–∏–π\n" +
                "üéØ –ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç –∏–¥–µ–∞–ª—å–Ω—ã–π –∏—Å—Ö–æ–¥ —Å–∏—Ç—É–∞—Ü–∏–∏, –µ—Å–ª–∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å —Ç–≤–æ–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º. –í–∫–ª—é—á–∞—è —Å—Ç–∞—Ç—å–∏ —Å–≤—è–∑–∞–Ω–Ω–æ–µ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ –∏ —Ç–µ–º–æ–π –≤–æ–ø—Ä–æ—Å–∞. \n\n" +
                "5. –ß—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–Ω–æ?" +
                "–û–±—å—è—Å–Ω–∏ —á—Ç–æ –Ω–∞—Ä—É—à–∏–ª –¥–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å —É—á–µ—Å—Ç–æ–º –∑–∞–∫–æ–Ω–æ–≤ –ö–∞–∑–∞—Ö–∞—Å—Ç–∞–Ω–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—Ç–∞—Ç—å—è–º–∏ –∫–æ—Ä–æ—Ç–∫–æ, –æ–¥–Ω–∏–º –∞–±–∑–∞—Ü–æ–º" +
                (isClarifying ? "–≠—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —Ç–µ–ø–µ—Ä—å –¥–∞–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.\n\n" : "") +
                "–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∞–π —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω –≤ –æ—Ç–≤–µ—Ç. –ß–µ—Ç—á–µ —Ä–∞–∑–ª–∏—á–∞–π –≤–∏–¥—ã –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤–∞—è, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è, —É–≥–æ–ª–æ–≤–Ω–∞—è, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ä–Ω–∞—è, –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è, –∫–æ–Ω—Å—Ç–∏—Ç—É—Ü–∏–æ–Ω–Ω–∞—è.)\n\n" +
                "–¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç–∞–π —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞: " + userQuery;
    }
}
