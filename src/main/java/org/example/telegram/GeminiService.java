package org.example.telegram;

import okhttp3.*;
import org.json.JSONArray;
import org.json.JSONObject;
import java.io.IOException;
import java.util.concurrent.TimeUnit;

public class GeminiService {
    private static final String API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent";
    private final String apiKey;

    private final OkHttpClient client = new OkHttpClient.Builder()
            .connectTimeout(30, TimeUnit.SECONDS)
            .readTimeout(30, TimeUnit.SECONDS)
            .writeTimeout(30, TimeUnit.SECONDS)
            .build();

    public GeminiService() {
        BotConfig config = new BotConfig();
        this.apiKey = config.getGeminiApiKey();
    }

    public String getLegalAnswer(String userQuery, boolean isClarifying, boolean isEnoughInfo) throws IOException {
        String prompt;

        if (isEnoughInfo) {
            prompt = "–¢—ã ‚Äî —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. " +
                    "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, —á–µ—Ç–∫–æ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ, —á—Ç–æ–±—ã –¥–∞–∂–µ –Ω–µ–ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –ø–æ–Ω—è–ª. " +
                    "–ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –ö–æ–¥–µ–∫—Å–æ–≤ –†–ö. –ü—Ä–æ–≤–µ—Ä—è–π, —á—Ç–æ —Å—Ç–∞—Ç—å—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —Ç–µ–º–µ. –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–π —Å—Ç–∞—Ç—å–∏ –Ω–µ—Ç, –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π." +
                    "–ò—Å–ø–æ–ª—å–∑—É–π Telegram Markdown v2 –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. " +
                    "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:\n\n" +
                    "üöó **[–ö—Ä–∞—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏]**\n\n" +
                    "**1Ô∏è‚É£ –ß—Ç–æ –¥–µ–ª–∞—Ç—å?**\n" +
                    "‚úÖ –û–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –Ω–æ–º–µ—Ä–∞–º–∏ —à–∞–≥–æ–≤ –∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã.\n\n" +
                    "**2Ô∏è‚É£ –ß—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ?**\n" +
                    "üö´ –£–∫–∞–∂–∏ –≥–ª–∞–≤–Ω—ã–µ –æ—à–∏–±–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ª—å–∑—è –¥–æ–ø—É—Å–∫–∞—Ç—å, –∏ –∏—Ö –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.\n\n" +
                    "**3Ô∏è‚É£ –ö–∞–∫ –≤—ã–∏–≥—Ä–∞—Ç—å —Å–ø–æ—Ä?**\n" +
                    "üí° –û–±—ä—è—Å–Ω–∏, –≤ –∫–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –º–æ–∂–Ω–æ –¥–æ–∫–∞–∑–∞—Ç—å —Å–≤–æ—é –ø—Ä–∞–≤–æ—Ç—É (—Å–≤–∏–¥–µ—Ç–µ–ª–∏, –∫–∞–º–µ—Ä—ã, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç. –¥.).\n\n" +
                    "**4Ô∏è‚É£ –í–∞–º –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å?**\n" +
                    "‚öñÔ∏è **–Æ—Ä–∏—Å—Ç—ã LexTrust** –ø–æ–º–æ–≥—É—Ç –∑–∞—â–∏—Ç–∏—Ç—å –ø—Ä–∞–≤–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã.\n" +
                    "üìû **–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è** üëâ [–ó–∞–ø–∏—Å–∞—Ç—å—Å—è](https://t.me/your_lawyer_bot)\n\n" +
                    "**5Ô∏è‚É£ –•–æ—Ä–æ—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —Å–æ–±—ã—Ç–∏–π**\n" +
                    "üéØ –û–ø–∏—à–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π –∏—Å—Ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å —Å –∫–∞–º–µ—Ä—ã –∏–ª–∏ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ –≤–∏–Ω—ã), —É–∫–∞–∂–∏, –∫–∞–∫–∞—è —Å—Ç–∞—Ç—å—è –∑–∞–∫–æ–Ω–∞ –ø–æ–º–æ–∂–µ—Ç –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.\n\n" +
                    "–¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç–∞–π —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + userQuery;
        } else {
            prompt = "–¢—ã ‚Äî —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞. " +
                    "–û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–∫–æ–Ω—ã. " +
                    "–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —Å–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã. " +
                    "–§–æ—Ä–º—É–ª–∏—Ä—É–π –∏—Ö –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ. –ü—Ä–∏–º–µ—Ä—ã:\n\n" +
                    "‚úÖ **–ö–æ–≥–¥–∞ –∏ –≥–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–æ–±—ã—Ç–∏–µ?**\n" +
                    "‚úÖ **–ï—Å—Ç—å –ª–∏ —Å–≤–∏–¥–µ—Ç–µ–ª–∏ –∏–ª–∏ –≤–∏–¥–µ–æ–∑–∞–ø–∏—Å—å?**\n" +
                    "‚úÖ **–í—ã–∑—ã–≤–∞–ª–∏ –ª–∏ –ø–æ–ª–∏—Ü–∏—é?**\n" +
                    "‚úÖ **–ö–∞–∫–∏–µ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è –º–µ–∂–¥—É —Å—Ç–æ—Ä–æ–Ω–∞–º–∏?**\n\n" +
                    "–ï—Å–ª–∏ —Å–ª—É—á–∞–π —Å–ª–æ–∂–Ω—ã–π, –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —é—Ä–∏—Å—Ç–∞. " +
                    "–¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–æ—Ç–∞–π —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: " + userQuery;
}

            if (isClarifying) {
            prompt += " –≠—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤–æ–ø—Ä–æ—Å, —Ç–µ–ø–µ—Ä—å –¥–∞–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.";
        }

        JSONObject requestJson = new JSONObject()
                .put("contents", new JSONArray()
                        .put(new JSONObject()
                                .put("parts", new JSONArray()
                                        .put(new JSONObject().put("text", prompt)))));

        RequestBody body = RequestBody.create(requestJson.toString(), MediaType.get("application/json"));
        Request request = new Request.Builder()
                .url(API_URL + "?key=" + apiKey)
                .post(body)
                .addHeader("Content-Type", "application/json")
                .build();

        try (Response response = client.newCall(request).execute()) {
            if (!response.isSuccessful()) {
                return "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò: " + response.message();
            }

            JSONObject responseJson = new JSONObject(response.body().string());
            JSONArray candidates = responseJson.optJSONArray("candidates");
            if (candidates != null && candidates.length() > 0) {
                String aiResponse = candidates.getJSONObject(0)
                        .getJSONObject("content")
                        .getJSONArray("parts")
                        .getJSONObject(0)
                        .getString("text");

                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–ª–∞–º—É —é—Ä. –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –∫–æ–Ω–µ—Ü –æ—Ç–≤–µ—Ç–∞
                String adText = "\n\nüîπ –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –Ω–∞—à—É –∫–æ–º–ø–∞–Ω–∏—é **LexTrust**! " +
                        "–ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –≤—Å–µ–º –ø—Ä–∞–≤–æ–≤—ã–º –≤–æ–ø—Ä–æ—Å–∞–º. " +
                        "üìû –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!";

                return aiResponse + adText;
            }
        } catch (Exception e) {
            e.printStackTrace();
            return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞.";
        }

        return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç.";
    }
}
